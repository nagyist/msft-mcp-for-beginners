# مطالعه موردی: افشای REST API در مدیریت API به عنوان یک سرور MCP

مدیریت API آزور، سرویسی است که یک دروازه را در بالای نقاط انتهایی API شما فراهم می‌کند. عملکرد آن به این صورت است که مدیریت API آزور مانند یک پراکسی در جلوی API‌های شما عمل می‌کند و می‌تواند تصمیم بگیرد که با درخواست‌های ورودی چه کند.

با استفاده از آن، انواع ویژگی‌ها را به دست می‌آورید مانند:

- **امنیت**، می‌توانید از همه مواردی مانند کلیدهای API، JWT تا شناسایی مدیریت شده استفاده کنید.
- **محدودیت نرخ**، یک ویژگی عالی این است که بتوانید تعیین کنید چند تماس در یک واحد زمانی معین عبور کند. این به اطمینان از این که همه کاربران تجربه خوبی دارند و همچنین سرویس شما با درخواست‌ها اشباع نمی‌شود کمک می‌کند.
- **مقیاس‌پذیری و توازن بار**. می‌توانید تعدادی نقطه انتهایی را برای توزیع بار تنظیم کنید و همچنین می‌توانید تصمیم بگیرید چگونه "توازن بار" اعمال شود.
- **ویژگی‌های هوش مصنوعی مانند کش معنایی**، محدودیت توکن و پایش توکن و موارد دیگر. این‌ها ویژگی‌های عالی هستند که پاسخگویی را بهبود می‌بخشند و همچنین به شما کمک می‌کنند بر هزینه‌های توکن خود نظارت داشته باشید. [اینجا بیشتر بخوانید](https://learn.microsoft.com/en-us/azure/api-management/genai-gateway-capabilities).

## چرا MCP + مدیریت API آزور؟

پروتکل مدل کانتکست (Model Context Protocol) به سرعت در حال تبدیل شدن به استانداردی برای برنامه‌های هوش مصنوعی عامل‌گرا و نحوه ارائه ابزارها و داده‌ها به روشی یکنواخت است. مدیریت API آزور انتخاب طبیعی است زمانی که شما نیاز به "مدیریت" API‌ها دارید. سرورهای MCP اغلب با APIهای دیگر برای پاسخ به درخواست‌ها در قالب یک ابزار ادغام می‌شوند. بنابراین ترکیب مدیریت API آزور و MCP بسیار منطقی است.

## مرور کلی

در این مورد استفاده خاص، ما خواهیم آموخت که چگونه نقاط انتهایی API را به عنوان یک سرور MCP افشا کنیم. با انجام این کار، می‌توانیم به راحتی این نقاط انتهایی را بخشی از یک برنامه عامل‌گرا کنیم و همزمان از ویژگی‌های مدیریت API آزور بهره ببریم.

## ویژگی‌های کلیدی

- شما روش‌های نقطه انتهایی را که می‌خواهید به عنوان ابزار افشا شوند انتخاب می‌کنید.
- ویژگی‌های اضافی که دریافت می‌کنید بستگی به تنظیمات سیاست‌ها در بخش سیاست API شما دارد. اما اینجا نشان می‌دهیم چگونه می‌توانید محدودیت نرخ را اضافه کنید.

## مرحله قبل: وارد کردن یک API

اگر قبلاً API در مدیریت API آزور دارید که عالی است، می‌توانید این مرحله را رد کنید. اگر نه، این لینک را بررسی کنید، [واردکردن API به مدیریت API آزور](https://learn.microsoft.com/en-us/azure/api-management/import-and-publish#import-and-publish-a-backend-api).

## افشای API به عنوان سرور MCP

برای افشای نقاط انتهایی API، مراحل زیر را دنبال کنید:

1. به پورتال آزور رفته و به آدرس زیر بروید <https://portal.azure.com/?Microsoft_Azure_ApiManagement=mcp>  
به نمونه مدیریت API خود مراجعه کنید.

1. در منوی سمت چپ، APIs > MCP Servers > + ایجاد سرور MCP جدید را انتخاب کنید.

1. در API، یک REST API را برای افشا به عنوان سرور MCP انتخاب کنید.

1. یک یا چند عملیات API را برای افشا به عنوان ابزار انتخاب کنید. می‌توانید همه عملیات‌ها یا فقط عملیات‌های خاصی را انتخاب کنید.

    ![انتخاب متدهایی برای افشا](https://learn.microsoft.com/en-us/azure/api-management/media/export-rest-mcp-server/create-mcp-server-small.png)

1. روی **ایجاد** کلیک کنید.

1. به منوی **APIs** و سپس **MCP Servers** بروید، باید موارد زیر را ببینید:

    ![مشاهده سرور MCP در پنل اصلی](https://learn.microsoft.com/en-us/azure/api-management/media/export-rest-mcp-server/mcp-server-list.png)

    سرور MCP ایجاد شده و عملیات API به عنوان ابزار افشا شده‌اند. سرور MCP در پنل MCP Servers فهرست شده است. ستون URL نقطه انتهایی سرور MCP را نشان می‌دهد که می‌توانید برای آزمون یا در داخل یک برنامه کلاینت آن را فراخوانی کنید.

## اختیاری: پیکربندی سیاست‌ها

مدیریت API آزور مفهوم اصلی سیاست‌ها را دارد که در آن قوانین مختلفی برای نقاط انتهایی تنظیم می‌کنید، مانند محدودیت نرخ یا کش معنایی. این سیاست‌ها به صورت XML نوشته می‌شوند.

در اینجا نحوه تنظیم یک سیاست برای محدود کردن نرخ سرور MCP آورده شده است:

1. در پورتال، زیر بخش APIs، **MCP Servers** را انتخاب کنید.

1. سرور MCP که ایجاد کردید را انتخاب کنید.

1. در منوی سمت چپ، زیر MCP، گزینه **Policies** را انتخاب کنید.

1. در ویرایشگر سیاست، سیاست‌هایی که می‌خواهید برای ابزارهای سرور MCP اعمال کنید را اضافه یا ویرایش کنید. سیاست‌ها به فرمت XML تعریف می‌شوند. برای مثال، می‌توانید سیاستی اضافه کنید که تماس‌ها به ابزارهای سرور MCP را (در این مثال، ۵ تماس در ۳۰ ثانیه برای هر آدرس IP کلاینت) محدود کند. XML که باعث محدودیت نرخ می‌شود، به صورت زیر است:

    ```xml
     <rate-limit-by-key calls="5" 
       renewal-period="30" 
       counter-key="@(context.Request.IpAddress)" 
       remaining-calls-variable-name="remainingCallsPerIP" 
    />
    ```
  
    تصویری از ویرایشگر سیاست:

    ![ویرایشگر سیاست](https://learn.microsoft.com/en-us/azure/api-management/media/export-rest-mcp-server/mcp-server-policies-small.png)

## امتحان کنید

اجازه دهید مطمئن شویم که سرور MCP ما به درستی کار می‌کند.

برای این کار از Visual Studio Code و GitHub Copilot و حالت Agent آن استفاده خواهیم کرد. سرور MCP را به یک *mcp.json* اضافه می‌کنیم. با این کار، Visual Studio Code به عنوان یک کلاینت با قابلیت‌های عامل‌گرا عمل خواهد کرد و کاربران می‌توانند یک پرامپت تایپ کنند و با آن سرور تعامل داشته باشند.

ببینید چگونه می‌توان سرور MCP را در Visual Studio Code اضافه کرد:

1. از دستور MCP: **Add Server** از Command Palette استفاده کنید.

1. وقتی خواسته شد، نوع سرور را انتخاب کنید: **HTTP (HTTP یا Server Sent Events)**.

1. URL سرور MCP در مدیریت API را وارد کنید. مثال: **https://<apim-service-name>.azure-api.net/<api-name>-mcp/sse** (برای نقطه انتهایی SSE) یا **https://<apim-service-name>.azure-api.net/<api-name>-mcp/mcp** (برای نقطه انتهایی MCP)، توجه کنید تفاوت بین ترنسپورت‌ها `/sse` یا `/mcp` است.

1. یک شناسه سرور به دلخواه خود وارد کنید. این مقدار مهم نیست اما به یادآوری این سرور کمک می‌کند.

1. انتخاب کنید که تنظیمات پیکربندی را در تنظیمات فضای کاری یا تنظیمات کاربر ذخیره کند.

  - **تنظیمات فضای کاری** - پیکربندی سرور در فایلی به نام .vscode/mcp.json ذخیره می‌شود که فقط در فضای کاری جاری در دسترس است.

    *mcp.json*

    ```json
    "servers": {
        "APIM petstore" : {
            "type": "sse",
            "url": "url-to-mcp-server/sse"
        }
    }
    ```
  
    یا اگر ترنسپورت خود را HTTP Streaming انتخاب کنید، کمی متفاوت خواهد بود:

    ```json
    "servers": {
        "APIM petstore" : {
            "type": "http",
            "url": "url-to-mcp-server/mcp"
        }
    }
    ```
  
  - **تنظیمات کاربر** - پیکربندی سرور به فایل *settings.json* کلی شما افزوده می‌شود و در همه فضای کاری‌ها قابل دسترسی است. پیکربندی به شکل زیر است:

    ![تنظیمات کاربر](https://learn.microsoft.com/en-us/azure/api-management/media/export-rest-mcp-server/mcp-servers-visual-studio-code.png)

1. همچنین شما باید پیکربندی هدر را اضافه کنید تا احراز هویت به درستی نسبت به مدیریت API آزور انجام شود. از هدر به نام **Ocp-Apim-Subscription-Key** استفاده می‌کند.

    - در اینجا چگونه می‌توانید آن را به تنظیمات اضافه کنید:

    ![افزودن هدر برای احراز هویت](https://learn.microsoft.com/en-us/azure/api-management/media/export-rest-mcp-server/mcp-server-with-header-visual-studio-code.png) این باعث می‌شود که یک پرامپت برای درخواست کلید API نمایش داده شود که می‌توانید آن را در پورتال آزور برای نمونه مدیریت API خود پیدا کنید.

   - برای افزودن آن به *mcp.json*، می‌توانید آن را به این صورت اضافه کنید:

    ```json
    "inputs": [
      {
        "type": "promptString",
        "id": "apim_key",
        "description": "API Key for Azure API Management",
        "password": true
      }
    ]
    "servers": {
        "APIM petstore" : {
            "type": "http",
            "url": "url-to-mcp-server/mcp",
            "headers": {
                "Ocp-Apim-Subscription-Key": "Bearer ${input:apim_key}"
            }
        }
    }
    ```
  
### استفاده از حالت Agent

اکنون در تنظیمات یا در *.vscode/mcp.json* همه چیز آماده است. بیایید امتحان کنیم.

باید یک آیکون ابزار مانند تصویر زیر باشد که ابزارهای افشا شده از سرور شما فهرست شده‌اند:

![ابزارها از سرور](https://learn.microsoft.com/en-us/azure/api-management/media/export-rest-mcp-server/tools-button-visual-studio-code.png)

1. روی آیکون ابزار کلیک کنید و باید فهرستی از ابزارها مانند تصویر زیر ببینید:

    ![ابزارها](https://learn.microsoft.com/en-us/azure/api-management/media/export-rest-mcp-server/select-tools-visual-studio-code.png)

1. یک پرامپت در چت وارد کنید تا ابزار را فراخوانی کنید. برای مثال اگر ابزاری برای دریافت اطلاعات درباره یک سفارش انتخاب کردید، می‌توانید از عامل در مورد یک سفارش بپرسید. این یک نمونه پرامپت است:

    ```text
    get information from order 2
    ```
  
    اکنون یک آیکون ابزار به شما نمایش داده می‌شود که از شما می‌خواهد برای ادامه فراخوانی ابزار را تأیید کنید. انتخاب کنید تا ابزار اجرا شود، اکنون خروجی مشابه زیر را باید ببینید:

    ![نتیجه از پرامپت](https://learn.microsoft.com/en-us/azure/api-management/media/export-rest-mcp-server/chat-results-visual-studio-code.png)

    **آنچه در بالا می‌بینید بستگی به ابزارهایی دارد که راه‌اندازی کرده‌اید، اما ایده این است که یک پاسخ متنی مانند تصویر بالا دریافت کنید**


## منابع

در اینجا روش‌هایی برای یادگیری بیشتر آورده شده است:

- [مقدمه‌ای بر مدیریت API آزور و MCP](https://learn.microsoft.com/en-us/azure/api-management/export-rest-mcp-server)
- [نمونه پایتون: سرورهای MCP راه دور امن با استفاده از مدیریت API آزور (آزمایشی)](https://github.com/Azure-Samples/remote-mcp-apim-functions-python)

- [آزمایش مجازسازی کلاینت MCP](https://github.com/Azure-Samples/AI-Gateway/tree/main/labs/mcp-client-authorization)

- [استفاده از افزونه مدیریت API آزور در VS Code برای وارد کردن و مدیریت APIها](https://learn.microsoft.com/en-us/azure/api-management/visual-studio-code-tutorial)

- [ثبت و کشف سرورهای راه دور MCP در Azure API Center](https://learn.microsoft.com/en-us/azure/api-center/register-discover-mcp-server)
- [دروازه هوش مصنوعی](https://github.com/Azure-Samples/AI-Gateway) مخزن عالی که بسیاری از قابلیت‌های هوش مصنوعی با مدیریت API آزور را نشان می‌دهد
- [کارگاه‌های دروازه هوش مصنوعی](https://azure-samples.github.io/AI-Gateway/) شامل کارگاه‌هایی با استفاده از پورتال آزور که راه بسیار خوبی برای شروع ارزیابی قابلیت‌های هوش مصنوعی است.

## ادامه کار

- بازگشت به: [مرور مطالعات موردی](./README.md)
- بعدی: [نمونه عوامل سفر هوش مصنوعی آزور](./travelagentsample.md)

---

<!-- CO-OP TRANSLATOR DISCLAIMER START -->
**سلب مسئولیت**:  
این سند با استفاده از سرویس ترجمه هوش مصنوعی [Co-op Translator](https://github.com/Azure/co-op-translator) ترجمه شده است. در حالی که ما تلاش می‌کنیم دقت را حفظ کنیم، لطفاً آگاه باشید که ترجمه‌های خودکار ممکن است حاوی اشتباهات یا نادرستی‌هایی باشند. سند اصلی به زبان بومی آن باید به عنوان منبع معتبر در نظر گرفته شود. برای اطلاعات حیاتی، ترجمه حرفه‌ای انسانی توصیه می‌شود. ما مسئول هیچ‌گونه سوءتفاهم یا تفسیر نادرستی که از استفاده از این ترجمه ناشی شود، نیستیم.
<!-- CO-OP TRANSLATOR DISCLAIMER END -->